#!/bin/sh -f

what=""

build_debug=no
build_verbose=no
build_icc=no
build_clang=no
build_mem=no

build_cl_exe=no
if [ "`uname | grep CYGWIN`" != "" ] ; then build_cl_exe=yes; fi

args=""
while test $# -ge 1 ; do
  case $1 in
    -g) build_debug=yes
        args="${args} $1"
        ;;
    -v) build_verbose=yes
        args="${args} $1"
        ;;
    -icc) build_icc=yes
        args="${args} $1"
        ;;
    -clang) build_clang=yes
        args="${args} $1"
        ;;
    -mem) build_mem=yes
        args="${args} $1"
        ;;
    -*) echo "unknown option : $1" ; exit ;;
     *) if [ $# = 1 ] ; then
          what=$1
        else         
          echo "unknown option : $1"
        fi
        ;;
  esac
  shift
done

if [ "${what}" = "" ] ; then
  find . -maxdepth 1 -name '*.cpp' -exec ./build ${args} {} \;
  exit
fi

if [ ${build_verbose} = "yes" ] ; then set -x;fi

exa=`basename ${what}`

exa=`echo ${exa} | sed -e 's:.cpp::g'`
exa=`echo ${exa} | sed -e 's:./::g'`

if [ ${exa} = "chbook" ] ; then exit;fi
if [ ${exa} = "whbook" ] ; then exit;fi

echo "build ${exa}..."

. ./use_cpp
. ./use_cc

if [ ${build_cl_exe} = "yes" ] ; then
  # rm painfull warnings about API strcpy, etc... deprecated.
  cppflags="${cppflags} /wd4996"
  ccflags0="${ccflags0} /wd4996"
fi

if [ ${build_cl_exe} = "yes" ] ; then
  cppflags="${cppflags} /I../.."
  cppflags="${cppflags} /I../g4tools/include" # if within G4.
else
  cppflags="${cppflags} -I../.."
  cppflags="${cppflags} -I../g4tools/include" # if within G4.
fi

if [ ${exa} = "wroot" ] ; then
  if [ ${build_cl_exe} = "yes" ] ; then
    cppflags="${cppflags} -DTOOLS_DONT_HAVE_ZLIB"  
  else
    libs="${libs} -lz"
  fi
fi
if [ ${exa} = "wroot_ntu_1000_cols" ] ; then
  if [ ${build_cl_exe} = "yes" ] ; then
    cppflags="${cppflags} -DTOOLS_DONT_HAVE_ZLIB"  
  else
    libs="${libs} -lz"
  fi
fi
if [ ${exa} = "rroot" -o ${exa} = "rxrayfluo" ] ; then
  if [ ${build_cl_exe} = "yes" ] ; then
    cppflags="${cppflags} -DTOOLS_DONT_HAVE_ZLIB"  
  else
    libs="${libs} -lz"
  fi
  if [ -f ../g4tools/src/csz_inflate.cc ] ; then
    cfiles="${cfiles} ../g4tools/src/csz_inflate.cc"
  else
    cfiles="${cfiles} ../../src/csz_inflate.cc"
  fi
fi
if [ ${exa} = "raxml" ] ; then
  # it needs expat.
  if [ ${build_cl_exe} = "yes" ] ; then
    expat_home=../../../../inexlib/ourex/expat
    if [ ! -d "${expat_home}" ] ; then
      echo "can't build raxml, expat not found at ${expat_home}."
      exit
    fi
    cflags="${cflags} -DTOOLS_USE_OUREX_EXPAT /I${expat_home}/include"
    cppflags="${cppflags} -DTOOLS_USE_OUREX_EXPAT /I${expat_home}/include"
    libs="${libs} ${expat_home}/bin_visual/libourex_expat.a"
  else
    libs="${libs} -lexpat"
  fi
fi

# let the freedom to some application to not use G4_cppflags.
cppflags="${G4_cppflags} ${cppflags}"

for file in ${cfiles} ; do
  oname=`basename ${file}`
  obj="./${oname}.o"
  if [ ${build_cl_exe} = "yes" ] ; then
    eval ${cc_compiler} /c ${ccflags} /Fo${obj} ${file}
  else
    eval ${cc_compiler} -c ${ccflags} -o ${obj} ${file}
    use_status=$?;if [ ${use_status} != 0 ] ; then exit ${use_status};fi
  fi
  objs="${objs} ${obj}"
done

if [ ${build_cl_exe} = "yes" ] ; then
  eval ${cpp_compiler} /c ${cppflags} /Fomain.o ${exa}.cpp
  eval ${cpp_linker} /nologo /OPT:NOREF /out:tools_test_${exa}.exe main.o ${objs} ${libs}
else
  eval ${cpp_linker} -o tools_test_${exa} ${cppflags} ${exa}.cpp ${objs} ${libs}
fi

/bin/rm -f ${objs}

